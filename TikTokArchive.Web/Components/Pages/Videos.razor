@page "/videos"
@rendermode InteractiveServer
@inject TikTokArchive.Web.Services.IVideoService VideoService
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@using TikTokArchive.Entities

<MudStack Spacing="3">
    <MudPaper Class="pa-4">
        <MudStack Spacing="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.h6">Add Video</MudText>
                <MudIconButton Icon="@(showAddVideo ? Icons.Material.Filled.Remove : Icons.Material.Filled.Add)"
                               Color="Color.Primary"
                               OnClick="@(() => showAddVideo = !showAddVideo)" />
            </MudStack>
            
            @if (showAddVideo)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudTextField @bind-Value="newVideoUrl" 
                                  Immediate="true"
                                  Label="TikTok Video URL" 
                                  Variant="Variant.Outlined" 
                                  FullWidth="true"
                                  Disabled="isSubmitting"
                                  Placeholder="Enter TikTok video URL" />
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="SubmitVideo"
                               Disabled="@(isSubmitting || string.IsNullOrWhiteSpace(newVideoUrl))">
                        @if (isSubmitting)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Justify="Justify.Center">
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText>Submitting...</MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudText>Submit</MudText>
                        }
                    </MudButton>
                </MudStack>
            }
        </MudStack>
    </MudPaper>
    
    <MudPaper Class="pa-4">
        <MudStack Spacing="2">
            <MudTextField @bind-Value="searchQuery"
                          Label="Search videos"
                          Variant="Variant.Outlined"
                          Placeholder="Search descriptions, creators, or tags"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyUp="HandleSearchKeyUp"
                          Immediate="false" />
            
            <MudStack Row="true" Spacing="1">
                <MudText Typo="Typo.caption" Class="align-self-center">Search in:</MudText>
                <MudChip T="string"
                         Color="@(searchFields.Contains("all") ? Color.Primary : Color.Default)"
                         OnClick="@(() => ToggleSearchField("all"))"
                         Style="cursor: pointer;">
                    All
                </MudChip>
                <MudChip T="string"
                         Color="@(searchFields.Contains("description") ? Color.Primary : Color.Default)"
                         OnClick="@(() => ToggleSearchField("description"))"
                         Style="cursor: pointer;">
                    Description
                </MudChip>
                <MudChip T="string"
                         Color="@(searchFields.Contains("creator") ? Color.Primary : Color.Default)"
                         OnClick="@(() => ToggleSearchField("creator"))"
                         Style="cursor: pointer;">
                    Creator
                </MudChip>
                <MudChip T="string"
                         Color="@(searchFields.Contains("tags") ? Color.Primary : Color.Default)"
                         OnClick="@(() => ToggleSearchField("tags"))"
                         Style="cursor: pointer;">
                    Tags
                </MudChip>
            </MudStack>
        </MudStack>
    </MudPaper>
        @if (!string.IsNullOrEmpty(selectedTag))
    {
        <MudChip T="string" 
                 Color="Color.Primary" 
                 OnClose="ClearTagFilter"
                 CloseIcon="@Icons.Material.Filled.Cancel"
                 Style="max-width: fit-content;">
            Filtered by: @selectedTag
        </MudChip>
    }
</MudStack>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mt-4" />
}
else
{
    <MudStack Spacing="3" Class="mt-4">
        @if (!videos.Any())
        {
            <MudAlert Severity="Severity.Info">
                @if (!string.IsNullOrEmpty(selectedTag))
                {
                    <text>No videos found with tag "@selectedTag"</text>
                }
                else
                {
                    <text>No videos found.</text>
                }
            </MudAlert>
        }
        else
        {
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; width: 100%;">
                @foreach (var video in videos)
                {
                    <MudCard>
                        <MudCardContent>
                            @if (!string.IsNullOrWhiteSpace(video.TikTokVideoId)){
                                var videoUrl = $"/api/video/{video.TikTokVideoId}/stream";
                                var posterUrl = $"/api/video/{video.TikTokVideoId}/thumbnail";
                                <video id="@video.Id"
                                       controls
                                       preload="metadata"
                                       width="100%"
                                       height="auto"
                                       style="max-width: 640px; background-color: #000;"
                                       poster="@posterUrl">
                                    <source src="@videoUrl" type="video/mp4" />
                                    Your browser does not support the video tag.
                                </video>
                            }
                            <MudText Typo="Typo.subtitle1" Class="mt-2">
                                @video.Creator?.DisplayName
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-2">
                                @video.Description
                            </MudText>
                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                                @foreach(var tag in video.Tags)
                                {
                                    <MudChip T="string" 
                                             Color="@(selectedTag == tag.Tag.Name ? Color.Secondary : Color.Primary)"
                                             OnClick="@(() => FilterByTag(tag.Tag.Name))"
                                             Style="cursor: pointer;">
                                        @tag.Tag.Name
                                    </MudChip>
                                }
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                           Color="Color.Primary" 
                                           Href="@GetDownloadUrl(video.TikTokVideoId)"
                                           Target="_blank"
                                           Title="Download video" />
                            <MudSpacer />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           OnClick="@(() => DeleteVideo(video.TikTokVideoId))"
                                           Title="Delete video" />
                        </MudCardActions>
                    </MudCard>
                }
            </div>

            @if (totalPages > 1)
            {
                <MudPagination 
                    Count="@totalPages" 
                    Selected="@currentPage" 
                    SelectedChanged="@OnPageChanged"
                    Color="Color.Primary"
                    ShowFirstButton="true"
                    ShowLastButton="true" />
                
                <MudText Typo="Typo.caption" Align="Align.Center">
                    Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalCount) of @totalCount videos
                </MudText>
            }
        }
    </MudStack>
}

@code {
    private List<Video> videos = new();
    private HashSet<string> loadedVideos = new();
    private string? selectedTag;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string newVideoUrl = string.Empty;
    private bool showAddVideo = false;
    private int currentPage = 1;
    private int pageSize = 20;
    private string searchQuery = string.Empty;
    private List<string> searchFields = new() { "all" };
    private System.Timers.Timer? searchDebounceTimer;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadVideos();
    }

    private void LoadVideo(string videoId)
    {
        loadedVideos.Add(videoId);
        StateHasChanged();
    }

    private async Task LoadVideos()
    {
        isLoading = true;
        loadedVideos.Clear(); // Clear loaded videos when navigating pages
        try
        {
            var searchQueryParam = string.IsNullOrWhiteSpace(searchQuery) ? null : searchQuery;
            var searchFieldsParam = searchFields.Contains("all") ? null : searchFields;
            
            var (loadedVideos, count) = await VideoService.GetVideosAsync(currentPage, pageSize, selectedTag, searchQueryParam, searchFieldsParam);
            videos = loadedVideos;
            totalCount = count;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading videos: {ex.Message}");
            videos = new List<Video>();
            totalCount = 0;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearchKeyUp(KeyboardEventArgs e)
    {
        searchDebounceTimer?.Stop();
        searchDebounceTimer = new System.Timers.Timer(500);
        searchDebounceTimer.Elapsed += async (sender, args) =>
        {
            searchDebounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadVideos();
                StateHasChanged();
            });
        };
        searchDebounceTimer.Start();
    }

    private async Task ToggleSearchField(string field)
    {
        if (field == "all")
        {
            searchFields.Clear();
            searchFields.Add("all");
        }
        else
        {
            searchFields.Remove("all");
            if (searchFields.Contains(field))
            {
                searchFields.Remove(field);
                if (searchFields.Count == 0)
                {
                    searchFields.Add("all");
                }
            }
            else
            {
                searchFields.Add(field);
            }
        }
        
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            currentPage = 1;
            await LoadVideos();
        }
    }

    private async Task SubmitVideo()
    {
        if (string.IsNullOrWhiteSpace(newVideoUrl))
        {
            Snackbar.Add("Please enter a video URL", Severity.Warning);
            return;
        }

        isSubmitting = true;
        StateHasChanged(); // Force immediate UI update to show loading state
        
        try
        {
            await VideoService.AddVideo(newVideoUrl);
            Snackbar.Add("Video submitted successfully!", Severity.Success);
            newVideoUrl = string.Empty;
            currentPage = 1; // Reset to first page to see the new video
            await LoadVideos();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to submit video: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadVideos();
    }

    private async Task FilterByTag(string tag)
    {
        selectedTag = tag;
        currentPage = 1;
        await LoadVideos();
    }

    private async Task ClearTagFilter()
    {
        selectedTag = null;
        currentPage = 1;
        await LoadVideos();
    }

    private async Task DeleteVideo(string videoId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete video {videoId}?"))
        {
            return;
        }

        try
        {
            await VideoService.DeleteVideoAsync(videoId);
            
            if (videos.Count == 1 && currentPage > 1)
            {
                currentPage--;
            }
            
            await LoadVideos();
            Snackbar.Add("Video deleted successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting video: {ex.Message}");
            Snackbar.Add($"Error deleting video: {ex.Message}", Severity.Error);
        }
    }

    private string GetDownloadUrl(string videoId)
    {
        return $"/api/video/{videoId}/download";
    }
}
